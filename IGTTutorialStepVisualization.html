<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MITK-IGT: IGT Visualization Filter and MITK Concepts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MITK-IGT
   </div>
   <div id="projectbrief">IGT Extension of MITK</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('IGTTutorialStepVisualization.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">IGT Visualization Filter and MITK Concepts</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The following code shows how to insert IGT tracking data into an mitk::DataStorage and render the data with the <a class="el" href="classmitk_1_1NavigationDataObjectVisualizationFilter.html" title="Class that reads NavigationData from input and transfers the information to the geometry of the assoc...">mitk::NavigationDataObjectVisualizationFilter</a> in an mitk::RenderWindow. The full code is shown below and can be found in MITK-Source/Modules/IGT/Tutorial/mitkIGTTutorialStep2.cpp. This tutorial is an extra target which can be build separately (see <a class="el" href="IGTTutorialStepFilterPipeline.html#IGTTutStep1Build">IGT Example Build Instructions</a>).</p>
<p>The example we are using here regards a moving tracker and a fixed object, and after tracking a transform to move the fixed object to the tracked one is calculated and applied.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="comment">//*************************************************************************</span></div>
<div class="line"><span class="comment">// What we will do...</span></div>
<div class="line"><span class="comment">//*************************************************************************</span></div>
<div class="line"><span class="comment">// This tutorial shows how to compose navigation datas. Therefore we render two objects.</span></div>
<div class="line"><span class="comment">//The first object is a cone that is tracked. The second object is a cylinder at a fixed position</span></div>
<div class="line"><span class="comment">//relative to the cone. At the end of the tracking, the cylinder is moved to its new relative position</span></div>
<div class="line"><span class="comment">//according to the last output of the tracking device.</span></div>
<div class="line"><span class="comment">//In addition to IGT tutorial step 1, the objects are added to a datastorage. Furthermore, a renderwindow</span></div>
<div class="line"><span class="comment">//is used for visual output.</span></div>
<div class="line"> </div>
</div><!-- fragment --><p>The next image describes, what happens in this example. The blue and red object are labeled with "1" at their initial position. Next, the blue object will move (approximately along the yellow arrow) to the second position, while the red one stayes fixed. Now we calculate the transform of the blue cones initial and moved position (1 -&gt; 2) and apply this transform to shift the red object to its final position (3). Now, the relative distance and orientation of the blue and red object is as it was in the beginning.</p>
<div class="image">
<img src="IGTTutorialStep2_overview.png" alt=""/>
<div class="caption">
Overlay of the three steps in this example: 1. Initial position, 2. Blue object moved along the yellow arc, 3. Final position, the red object is moved to get the initial relative position compared to the blue object.</div></div>
<p> <br  />
 </p>
<h1><a class="anchor" id="igtTut2sec1"></a>
Set up Render Window and Tracking Device</h1>
<p>First of all, we create a new render window. For simplicity, we are not using the MITK workbench yet but run this example as a stand alone application. Hence, we need to create a render window and a data storage.</p>
<div class="fragment"><div class="line">  <span class="comment">//General code rendering the data in a renderwindow. See MITK Tutorial Step1 for more details.</span></div>
<div class="line">  mitk::StandaloneDataStorage::Pointer dataStorage = mitk::StandaloneDataStorage::New();</div>
<div class="line">  mitk::RenderWindow::Pointer renderWindow = mitk::RenderWindow::New();</div>
<div class="line">  mitk::DataNode::Pointer dataNode = mitk::DataNode::New();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Here, we want a 3D renderwindow</span></div>
<div class="line">  renderWindow-&gt;GetRenderer()-&gt;SetMapperID(mitk::BaseRenderer::Standard3D);</div>
<div class="line">  renderWindow-&gt;GetVtkRenderWindow()-&gt;SetSize(500, 500);</div>
<div class="line">  renderWindow-&gt;GetRenderer()-&gt;Resize(500, 500);</div>
<div class="line">  <span class="comment">//Connect datastorage and renderwindow</span></div>
<div class="line">  renderWindow-&gt;GetRenderer()-&gt;SetDataStorage(dataStorage);</div>
<div class="line"> </div>
</div><!-- fragment --><p>Next, we need to set up the tracking device like we did in the last tutorial step <a class="el" href="IGTTutorialStepFilterPipeline.html">IGT filter pipeline</a> . We set additionally some boundaries for the tracking.</p>
<div class="fragment"><div class="line">  <span class="comment">//Virtual tracking device to generate random positions</span></div>
<div class="line">  mitk::VirtualTrackingDevice::Pointer tracker = mitk::VirtualTrackingDevice::New();</div>
<div class="line">  <span class="comment">//Bounds (within the random numbers are generated) must be set before the tools are added</span></div>
<div class="line">  <span class="keywordtype">double</span> bound = 10.0;</div>
<div class="line">  mitk::ScalarType bounds[] = { -bound, bound, -bound, bound, -bound, bound };</div>
<div class="line">  tracker-&gt;SetBounds(bounds);</div>
<div class="line">  tracker-&gt;AddTool(<span class="stringliteral">&quot;tool1&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Tracking device source to get the data</span></div>
<div class="line">  mitk::TrackingDeviceSource::Pointer source = mitk::TrackingDeviceSource::New();</div>
<div class="line">  source-&gt;SetTrackingDevice(tracker);</div>
<div class="line">  source-&gt;Connect();</div>
<div class="line"> </div>
</div><!-- fragment --><h1><a class="anchor" id="igtTut2sec2"></a>
Create Objects</h1>
<p>Now we create a fixed and a moving object. For the moving (tracked) object, we decided for a blue cone. First, we set the name and color and add it to the data storage. Next, we need to create a visualitation filter to display it. Here, we connect in the visualization filter the output of our tracking device source to the cone representation.</p>
<div class="fragment"><div class="line">  <span class="comment">//Cone representation for rendering of the moving object</span></div>
<div class="line">  mitk::Cone::Pointer cone = mitk::Cone::New();</div>
<div class="line">  dataNode-&gt;SetData(cone);</div>
<div class="line">  dataNode-&gt;SetName(<span class="stringliteral">&quot;My tracked object&quot;</span>);</div>
<div class="line">  dataNode-&gt;SetColor(0.0, 1.0, 1.0);</div>
<div class="line">  dataStorage-&gt;Add(dataNode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Filter for rendering the cone at correct postion and orientation</span></div>
<div class="line">  mitk::NavigationDataObjectVisualizationFilter::Pointer visualizer = mitk::NavigationDataObjectVisualizationFilter::New();</div>
<div class="line">  visualizer-&gt;SetInput(0, source-&gt;GetOutput());</div>
<div class="line">  visualizer-&gt;SetRepresentationObject(0, cone.GetPointer());</div>
</div><!-- fragment --><p>The fixed object is created accordingly, with a cylindrical shape and red color. As it is not tracked, we define an initial position and orientation, set it to the cylinder object and also store it as fixedNavigationData for later usage. As the object is not continuously updated, we don't need a visualization filter.</p>
<div class="fragment"><div class="line">  <span class="comment">//Cylinder representation for rendering of the fixed object</span></div>
<div class="line">  mitk::DataNode::Pointer cylinderNode = mitk::DataNode::New();</div>
<div class="line">  mitk::Cylinder::Pointer cylinder = mitk::Cylinder::New();</div>
<div class="line">  cylinderNode-&gt;SetData(cylinder);</div>
<div class="line">  cylinderNode-&gt;SetName(<span class="stringliteral">&quot;My fixed object&quot;</span>);</div>
<div class="line">  cylinderNode-&gt;SetColor(1.0, 0.0, 0.0);</div>
<div class="line">  dataStorage-&gt;Add(cylinderNode);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Define a rotation and a translation for the fixed object</span></div>
<div class="line">  mitk::Matrix3D rotationMatrix;</div>
<div class="line">  rotationMatrix.SetIdentity();</div>
<div class="line">  <span class="keywordtype">double</span> alpha = 0.3;</div>
<div class="line">  rotationMatrix[1][1] = cos(alpha);</div>
<div class="line">  rotationMatrix[1][2] = -sin(alpha);</div>
<div class="line">  rotationMatrix[2][1] = sin(alpha);</div>
<div class="line">  rotationMatrix[2][2] = cos(alpha);</div>
<div class="line"> </div>
<div class="line">  mitk::Vector3D offset;</div>
<div class="line">  offset.Fill(5.0);</div>
<div class="line">  <span class="comment">//Add rotation and translation to affine transform</span></div>
<div class="line">  mitk::AffineTransform3D::Pointer affineTransform3D = mitk::AffineTransform3D::New();</div>
<div class="line">  affineTransform3D-&gt;SetOffset(offset);</div>
<div class="line">  affineTransform3D-&gt;SetMatrix(rotationMatrix);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//apply rotation and translation</span></div>
<div class="line">  mitk::NavigationData::Pointer fixedNavigationData = mitk::NavigationData::New(affineTransform3D);</div>
<div class="line">  cylinder-&gt;GetGeometry()-&gt;SetIndexToWorldTransform(fixedNavigationData-&gt;GetAffineTransform3D());</div>
</div><!-- fragment --><h1><a class="anchor" id="igtTut2sec3"></a>
The Tracking loop</h1>
<p>Before we start tracking, we need to initialize the rendering manager.</p>
<div class="fragment"><div class="line">  <span class="comment">// Global reinit with the bounds of the virtual tracking device</span></div>
<div class="line">  <span class="keyword">auto</span> timeGeometry = dataStorage-&gt;ComputeBoundingGeometry3D(dataStorage-&gt;GetAll());</div>
<div class="line">  mitk::BaseGeometry::Pointer geometry = timeGeometry-&gt;GetGeometryForTimeStep(0);</div>
<div class="line">  geometry-&gt;SetBounds(bounds);</div>
<div class="line"> </div>
<div class="line">  mitk::RenderingManager::GetInstance()-&gt;InitializeViews(geometry);</div>
<div class="line"> </div>
<div class="line">  source-&gt;StartTracking();</div>
</div><!-- fragment --><p>We now move the tracked blue cone object for 75 steps, update the rendering and print the position to the output console.</p>
<div class="fragment"><div class="line">  <span class="comment">//Generate and render 75 time steps to move the tracked object</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 75; ++i)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">//Update the cone position</span></div>
<div class="line">    visualizer-&gt;Update();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//Update rendering</span></div>
<div class="line">    renderWindow-&gt;GetVtkRenderWindow()-&gt;Render();</div>
<div class="line">    mitk::RenderingManager::GetInstance()-&gt;RequestUpdateAll();</div>
<div class="line"> </div>
<div class="line">    MITK_INFO &lt;&lt; <span class="stringliteral">&quot;Position &quot;</span> &lt;&lt; source-&gt;GetOutput()-&gt;GetPosition();</div>
<div class="line">    <span class="comment">//Slight delay for the random numbers</span></div>
<div class="line">    itksys::SystemTools::Delay(100);</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">//Stop the tracking device and disconnect it</span></div>
<div class="line">  <span class="comment">//The tracking is done, now we want to move the fixed object to its correct relative position regarding the tracked object.</span></div>
<div class="line">  source-&gt;StopTracking();</div>
<div class="line">  source-&gt;Disconnect();</div>
</div><!-- fragment --><h1><a class="anchor" id="igtTut2sec4"></a>
Final Transform</h1>
<p>Finally, we apply the new position of the tracked object (source-&gt;GetOutput) to the stored fixedNavigationData transform and update the rendering one last time.</p>
<div class="fragment"><div class="line">  <span class="comment">//Now the tracking is finished and we can use the transformation to move</span></div>
<div class="line">  <span class="comment">//the fixed object to its correct position relative to the new position</span></div>
<div class="line">  <span class="comment">//of the moving/tracked object. Therefore, we compose the navigation datas.</span></div>
<div class="line">  fixedNavigationData-&gt;Compose(source-&gt;GetOutput(), <span class="keyword">false</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Update the transformation matrix of the cylinder</span></div>
<div class="line">  cylinder-&gt;GetGeometry()-&gt;SetIndexToWorldTransform(fixedNavigationData-&gt;GetAffineTransform3D());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Update the rendering</span></div>
<div class="line">  renderWindow-&gt;GetVtkRenderWindow()-&gt;Render();</div>
<div class="line">  mitk::RenderingManager::GetInstance()-&gt;RequestUpdateAll();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//Wait a little before closing the renderwindow</span></div>
<div class="line">  itksys::SystemTools::Delay(2000);</div>
</div><!-- fragment --><p>The red cylinder is now moved accodring to the tracked transform.</p>
<p>Return to the <a class="el" href="IGTTutorialOverview.html">[IGT Tutorial Overview]</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="mitkigt.html">MITK-IGT</a></li><li class="navelem"><a class="el" href="IGTTutorialOverview.html">IGT Tutorial Overview</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
